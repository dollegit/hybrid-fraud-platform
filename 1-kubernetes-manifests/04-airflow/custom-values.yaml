# Airflow Helm Chart 1.18.0 - KubernetesExecutor + External Postgres + GitSync + Migrations

executor: KubernetesExecutor

images:
  airflow:
    repository: psalmprax/airflow-custom
    tag: "2.9.2-p1"
    pullPolicy: Always
  pod_template:
    repository: psalmprax/airflow-custom
    tag: "2.9.2-p1"
    pullPolicy: Always
  flower:
    repository: psalmprax/airflow-custom
    tag: "2.9.2-p1"
    pullPolicy: Always
  statsd:
    repository: prom/statsd-exporter
    tag: "v0.28.0"
    pullPolicy: Always
  pgbouncer:
    repository: psalmprax/airflow-custom
    tag: "2.9.2-p1"
    pullPolicy: Always
  pgbouncerExporter:
    repository: psalmprax/airflow-custom
    tag: "2.9.2-p1"
    pullPolicy: Always
  gitSync:
    repository: registry.k8s.io/git-sync/git-sync
    tag: v4.3.0
    pullPolicy: Always

  useDefaultImageForMigration: true
  migrationsWaitTimeout: 600

# Environment for all pods

# env:
# - name: ENVIRONMENT
#   value: dev

# extraEnv: |
#   name: AIRFLOW__CORE__DEFAULT_TIMEZONE
#   value: "Asia/Shanghai"

# DAGs configuration

dags:
  # path: /opt/airflow/dags
  gitSync:
    enabled: true
    repo: "https://github.com/dollegit/hybrid-fraud-platform.git"
    branch: "master"
    rev: "HEAD"
    depth: 1
    subPath: "2-airflow/dags"
    wait: 30

# Airflow-specific settings

airflow:
  env:
    - name: AIRFLOW__CORE__EXECUTOR
      value: "KubernetesExecutor"
    - name: AIRFLOW__CORE__AUTH_MANAGER
      value: "airflow.api_fastapi.auth.managers.basic.BasicAuthManager"
    # REQUIRED for Airflow 3.x with external DB
    - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
      valueFrom:
        secretKeyRef:
          name: airflow-db-secret
          key: connection
    - name: TZ
      value: "Asia/Shanghai"
  securityContext:
    runAsUser: 65534
    runAsGroup: 0
    fsGroup: 65533
  logging:
    remote_logging: "True"
    colored_console_log: true
    remote_log_conn_id: "minio_default"
    remote_base_log_folder: "s3://airflow-logs/"
  config:
    kubernetes_executor:
      in_cluster: "true"
      delete_worker_pods: "false"
      worker_pods_termination_grace_period: "150"
      verify_ssl: "false"
  kubernetesPodTemplate: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: airflow-task-pod
    spec:
      securityContext:
        fsGroup: 65533
        restartPolicy: Never

# Service accounts

serviceAccount:
  create: true
  name: airflow

worker_service_account:
  create: true
  name: airflow-worker

scheduler:
  replicas: 1
  env:
  - name: AIRFLOW__CORE__LOAD_EXAMPLES
    value: "false"

webserver:
  enabled: true
  defaultUser:
    enabled: true
    username: admin
    password: admin
    role: Admin
    email: admin@example.com

triggerer:
  enabled: false

dagProcessor:
  enabled: true

workers:
  persistence:
    enabled: false
  serviceAccount:
    create: false
    name: airflow-worker

postgresql:
  enabled: false

externalDatabase:
  enabled: true
  type: postgresql
  host: airflow-postgresql.airflow.svc.cluster.local
  port: 5432
  database: airflow
  user: airflow
  existingSecret: airflow-db-secret
  existingSecretKey: connection

# pgbouncer:
#   enabled: true

statsd:
  enabled: true
  securityContext:
    runAsUser: 65534
    runAsGroup: 0
    fsGroup: 0

logs:
  persistence:
    enabled: true
    size: 2Gi

redis:
  enabled: false

# Migration jobs - required for schema upgrade

jobs:
  migrateDatabase:  
    enabled: true
    # useHelmHooks: false
    # extraEnv:
    #   - name: AIRFLOW__CORE__MIGRATION_WAIT_TIMEOUT
    # value: "600"
    # createUserJob:
    #   useHelmHooks: false

waitForMigrations:
  timeoutSeconds: 600

# ===============================================================
# GitOps Compatibility (Argo CD / Flux / Rancher / Terraform)
# ===============================================================
createUserJob:
  useHelmHooks: false
  applyCustomEnv: false

migrateDatabaseJob:
  useHelmHooks: false
  applyCustomEnv: false

# Extra RBAC for cross-namespace pods (optional)

extraResources:
- apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    name: airflow-k8s-role
    namespace: airflow
  rules:
  - apiGroups: [""]
    resources: ["pods","pods/log","pods/exec"]
    verbs: ["get","list","watch","create","delete","patch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create","patch"]
- apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: airflow-k8s-rolebinding
    namespace: airflow
  subjects:
    - kind: ServiceAccount
      name: airflow-worker
      namespace: airflow
  roleRef:
    kind: Role
    name: airflow-k8s-role
    apiGroup: rbac.authorization.k8s.io
