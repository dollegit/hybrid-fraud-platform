# ---------------------------------------
# EXECUTOR
# ---------------------------------------
executor: KubernetesExecutor

# ---------------------------------------
# IMAGES
# ---------------------------------------
images:
  airflow:
    repository: psalmprax/airflow-custom
    tag: 2.9.2-p1
    pullPolicy: Always

  pod_template:
    repository: psalmprax/airflow-custom
    tag: 2.9.2-p1
    pullPolicy: Always

# ---------------------------------------
# Kubernetes Settings
# ---------------------------------------
kubernetes:
  namespace: airflow
  delete_worker_pods: false
  worker_service_account_name: airflow-sa
  worker_pods_termination_grace_period: 30

# ---------------------------------------
# DAGs via GitSync
# ---------------------------------------
dags:
  persistence:
    enabled: false
  gitSync:
    enabled: true
    repo: "https://github.com/psalmprax/hybrid-fraud-platform.git"
    branch: "master"
    subPath: "2-airflow/dags"

# dags:
#   persistence:
#     enabled: true
#     size: 2Gi
#   gitSync:
#     enabled: false

# ---------------------------------------
# Logging + Workers
# ---------------------------------------
logs:
  persistence:
    enabled: true       # persist logs for visibility
    size: 2Gi

workers:
  persistence:
    enabled: false      # worker ephemeral pods, no DAGs needed here

# ---------------------------------------
# Disable built-in Postgres + Redis
# ---------------------------------------
postgresql:
  enabled: false

redis:
  enabled: false

# ---------------------------------------
# External DB Configuration
# ---------------------------------------
externalDatabase:
  existingSecret: airflow-db-secret
  host: airflow-postgresql
  port: 5432

jobs:
  migrateDatabase:
    enabled: true

waitForMigrations:
  timeoutSeconds: 600

# ---------------------------------------
# Airflow Config
# ---------------------------------------
airflow:
  extraEnv:
    - name: AIRFLOW__CORE__LOAD_EXAMPLES
      value: "false"

  config:
    logging:
      remote_logging: "True"
      colored_console_log: true
      remote_log_conn_id: "minio_default"
      remote_base_log_folder: "s3://airflow-logs/"

    kubernetes_executor:
      log_server_sidecar:
        enabled: false
      delete_worker_pods: false
      worker_pods_termination_grace_period: 150

  connections:
    - id: kubernetes_default
      type: kubernetes
      extra: |
        {
          "in_cluster": true,
          "disable_verify_ssl": true
        }
    - id: spark_default
      type: spark
      extra: |
        {
          "master": "local[*]"
        }
      # The master URL for Spark must be in the 'extra' field.

# ---------------------------------------
# Components
# ---------------------------------------
scheduler:
  replicas: 1

webserver:
  defaultUser:
    enabled: true
    username: admin
    password: admin
    role: Admin
    email: admin@example.com

apiServer: {}
triggerer: {}
dagProcessor: {}

# ---------------------------------------
# KubernetesExecutor Task Pod Template
# ---------------------------------------
kubernetesPodTemplate: |
  apiVersion: v1
  kind: Pod
  metadata:
    name: airflow-task-pod
  spec:
    restartPolicy: Never
    containers:
      - name: base
        image: psalmprax/airflow-custom:2.9.2-p1
        command: ["airflow"]
        args: ["kubernetes", "worker"]
        volumeMounts:
          - name: dags
            mountPath: /opt/airflow/dags
    volumes:
      - name: dags
        emptyDir: {}

# ---------------------------------------
# Airflow Service Account
# ---------------------------------------
serviceAccount:
  create: true
  name: airflow-sa

rbac:
  create: true

# ---------------------------------------
# EXTRA RESOURCES (RBAC for Airflow + Spark)
# ---------------------------------------
extraResources:

  # RBAC in AIRFLOW namespace
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: airflow-k8s-role
      namespace: airflow
    rules:
      - apiGroups: [""]
        resources: ["pods", "pods/log", "pods/exec"]
        verbs: ["get", "list", "watch", "create", "delete", "patch"]
      - apiGroups: [""]
        resources: ["events"]
        verbs: ["create", "patch"]

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: airflow-k8s-rolebinding
      namespace: airflow
    subjects:
      - kind: ServiceAccount
        name: airflow-sa
        namespace: airflow
    roleRef:
      kind: Role
      name: airflow-k8s-role
      apiGroup: rbac.authorization.k8s.io

  # RBAC in spark-jobs namespace (Spark Operator)
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: airflow-k8s-spark-role
      namespace: spark-jobs
    rules:
      - apiGroups: ["sparkoperator.k8s.io"]
        resources: ["sparkapplications", "sparkapplications/status"]
        verbs: ["get", "list", "watch", "create", "delete"]
      - apiGroups: [""]
        resources: ["pods", "pods/log", "services"]
        verbs: ["get", "list", "watch", "create", "delete", "patch"]

  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: airflow-k8s-spark-rolebinding
      namespace: spark-jobs
    subjects:
      - kind: ServiceAccount
        name: airflow-sa
        namespace: airflow
    roleRef:
      kind: Role
      name: airflow-k8s-spark-role
      apiGroup: rbac.authorization.k8s.io

  # RBAC in spark-cluster (Spark Cluster) with Airflow
  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: airflow-spark
      namespace: airflow
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: spark-job-manager
      namespace: spark-jobs
    rules:
    - apiGroups: ["sparkoperator.k8s.io"]
      resources: ["sparkapplications"]
      verbs: ["create", "get", "list", "watch", "delete"]
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: airflow-spark-job-manager-binding
      namespace: spark-jobs
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: spark-job-manager
    subjects:
    - kind: ServiceAccount
      name: airflow-spark
      namespace: airflow
